name: Azure Static Web Apps CI/CD 

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  WORKING_DIRECTORY: './TableWhispersFront'

jobs:
  # Quality checks for PRs and pushes
  quality_checks:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Code Quality & Tests
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: Run Prettier check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ’… Checking code formatting..."
          npm run format:check
          echo "âœ… Code formatting check completed"

      - name: Run TypeScript check (if applicable)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ”· Running TypeScript check..."
          npm run type-check
          echo "âœ… TypeScript check completed"
        continue-on-error: true

      - name: Run unit tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ§ª Running unit tests..."
          npm run test:unit
          echo "âœ… Unit tests completed"
        env:
          CI: true

      - name: Run component tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ§© Running component tests..."
          npm run test:components
          echo "âœ… Component tests completed"
        continue-on-error: true

      - name: Generate test coverage
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ“Š Generating test coverage..."
          npm run test:coverage
          echo "âœ… Coverage generated"
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          directory: ${{ env.WORKING_DIRECTORY }}/coverage
          flags: frontend
          name: frontend-coverage
        continue-on-error: true

      - name: Security audit
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level moderate || echo "âš ï¸ Security audit completed with warnings"

      - name: Bundle analysis (build test)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ“¦ Testing build process..."
          npm run build
          echo "âœ… Build test completed"
        env:
          VITE_BACKEND_API: 'https://test.example.com'
          VITE_GOOGLE_AUTH: 'test-key'

      - name: Check bundle size
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ“ Checking bundle size..."
          npm run analyze:bundle
          echo "âœ… Bundle analysis completed"
        continue-on-error: true

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            ${{ env.WORKING_DIRECTORY }}/coverage/
            ${{ env.WORKING_DIRECTORY }}/dist/
            ${{ env.WORKING_DIRECTORY }}/test-results.xml
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = `## ğŸ¨ Frontend Quality Check Results\n\n`;
            comment += `âœ… **ESLint:** Passed\n`;
            comment += `ğŸ’… **Prettier:** Passed\n`;
            comment += `ğŸ§ª **Tests:** Passed\n`;
            comment += `ğŸ”’ **Security:** Scanned\n`;
            comment += `ğŸ“¦ **Build:** Successful\n\n`;
            
            // Try to read bundle analysis
            const bundlePath = '${{ env.WORKING_DIRECTORY }}/dist';
            try {
              comment += `### ğŸ“Š Bundle Info:\n`;
              comment += `- Build completed successfully\n`;
              comment += `- Static assets ready for deployment\n\n`;
            } catch (error) {
              console.log('Could not read bundle info');
            }
            
            comment += `> Commit: ${context.sha.slice(0, 7)}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Build and deploy job
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    needs: quality_checks
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    timeout-minutes: 15
    permissions:
       id-token: write
       contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ“¦ Installing dependencies for production build..."
          npm ci --production=false
          echo "âœ… Dependencies installed"

      - name: Install OIDC Client from Core Package
        run: npm install @actions/core@1.6.0 @actions/http-client

      - name: Get Id Token
        uses: actions/github-script@v7
        id: idtoken
        with:
           script: |
               const coredemo = require('@actions/core')
               return await coredemo.getIDToken()
           result-encoding: string

      - name: Build application
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ—ï¸ Building application..."
          npm run build
          echo "âœ… Build completed successfully"
          
          echo "ğŸ“Š Build statistics:"
          ls -la dist/
          du -sh dist/
        env:
          VITE_BACKEND_API: ${{ secrets.BACKEND_API_URL }}
          VITE_GOOGLE_AUTH: ${{ secrets.GOOGLE_AUTH }}
          NODE_ENV: production

      - name: Generate build info
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ“‹ Generating build information..."
          cat > dist/build-info.json << EOF
          {
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "gitCommit": "${{ github.sha }}",
            "gitBranch": "${{ github.ref_name }}",
            "buildNumber": "${{ github.run_number }}",
            "environment": "production",
            "version": "$(npm version --json | jq -r '.\"tablewhispers-frontend\" // \"1.0.0\"')"
          }
          EOF
          echo "âœ… Build info generated"

      - name: Build And Deploy to Azure
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_LEMON_MUSHROOM_0B6D89F03 }}
          action: "upload"
          app_location: "${{ env.WORKING_DIRECTORY }}"
          api_location: ""
          output_location: "dist"
          github_id_token: ${{ steps.idtoken.outputs.result }}
        env:
          VITE_BACKEND_API: ${{ secrets.BACKEND_API_URL }}
          VITE_GOOGLE_AUTH: ${{ secrets.GOOGLE_AUTH }}

      - name: Post-deployment verification
        if: steps.builddeploy.outcome == 'success'
        run: |
          echo "ğŸ¥ Running post-deployment checks..."
          echo "âœ… Deployment completed successfully"
          echo "ğŸŒ Static Web App deployed to Azure"
          
          # Optional: Add basic connectivity test
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸ” Deployment verification completed"
          fi

  # Close PR job
  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    timeout-minutes: 5

    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_LEMON_MUSHROOM_0B6D89F03 }}
          action: "close"

      - name: Cleanup notification
        run: |
          echo "ğŸ§¹ Pull request deployment cleaned up"
          echo "ğŸ“Š PR #${{ github.event.number }} closed"

  # Notify deployment status
  notify:
    if: always() && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed'))
    needs: [quality_checks, build_and_deploy_job]
    runs-on: ubuntu-latest
    name: Notify Status

    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.quality_checks.result }}" == "success" && "${{ needs.build_and_deploy_job.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=ğŸ‰ Frontend deployment successful!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Frontend deployment failed!" >> $GITHUB_OUTPUT
          fi

      - name: Success notification
        if: steps.status.outputs.status == 'success'
        run: |
          echo "ğŸ‰ Frontend deployment successful!"
          echo "âœ… Quality checks passed"
          echo "ğŸ—ï¸ Build completed"
          echo "ğŸš€ Deployed to Azure Static Web Apps"

      - name: Failure notification
        if: steps.status.outputs.status == 'failure'
        run: |
          echo "âŒ Frontend deployment failed!"
          echo "ğŸ” Quality checks: ${{ needs.quality_checks.result }}"
          echo "ğŸ—ï¸ Build & Deploy: ${{ needs.build_and_deploy_job.result }}"
          echo "ğŸ“‹ Check the logs for details"